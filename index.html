<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI HP作成サポートシステム</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background: #f0f2f5; 
        }
        
        .container { display: flex; height: 100vh; }
        .preview-pane { 
            flex: 2; 
            background: white; 
            display: flex; 
            flex-direction: column;
        }
        .sidebar { 
            flex: 1; 
            background: white; 
            border-left: 1px solid #ddd; 
            display: flex; 
            flex-direction: column; 
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
        }
        
        .header { 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        .header h2 { font-size: 18px; margin-bottom: 5px; }
        .header p { font-size: 12px; opacity: 0.9; }
        
        .preview-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .preview-header h3 {
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }
        .preview-actions {
            display: flex;
            gap: 10px;
        }
        .preview-actions button {
            padding: 6px 12px;
            font-size: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preview-actions button:hover {
            background: #f5f5f5;
            border-color: #667eea;
            color: #667eea;
        }
        
        .voice-status { 
            padding: 12px 15px; 
            text-align: center; 
            font-size: 13px; 
            border-bottom: 1px solid #e0e0e0; 
            font-weight: 500; 
        }
        .voice-status.listening { 
            background: #e8f5e9; 
            color: #2e7d32; 
            animation: pulse 2s infinite; 
        }
        .voice-status.stopped { 
            background: #ffebee; 
            color: #c62828; 
        }
        .voice-status.speaking { 
            background: #e1f5fe; 
            color: #0277bd; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.8; } 
        }
        
        .actions { 
            display: flex; 
            gap: 10px; 
            padding: 15px; 
            border-bottom: 1px solid #e0e0e0; 
            flex-wrap: wrap; 
        }
        .actions button { 
            flex: 1; 
            padding: 10px; 
            font-size: 12px; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.2s; 
            min-width: 80px; 
        }
        .actions button:hover { 
            background: #f5f5f5; 
            border-color: #667eea; 
            color: #667eea; 
        }
        .actions button.primary { 
            background: #667eea; 
            color: white; 
            border-color: #667eea; 
        }
        .actions button.primary:hover { 
            background: #5568d3; 
        }
        .actions button.success {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        .actions button.success:hover {
            background: #45a049;
        }
        
        .chat-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
        }
        .message { 
            margin-bottom: 15px; 
            padding: 12px 15px; 
            border-radius: 12px; 
            line-height: 1.5; 
            animation: fadeIn 0.3s;
            white-space: pre-wrap;
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .message.user { 
            background: #e3f2fd; 
            margin-left: 40px; 
            border-bottom-right-radius: 4px; 
        }
        .message.ai { 
            background: #f5f5f5; 
            margin-right: 40px; 
            border-bottom-left-radius: 4px; 
        }
        .message.system { 
            background: #fff3e0; 
            text-align: center; 
            font-size: 12px; 
        }
        .message.interim { 
            background: #fce4ec; 
            margin-left: 40px; 
            opacity: 0.7; 
            font-style: italic; 
        }
        .message strong { 
            display: block; 
            font-size: 11px; 
            color: #666; 
            margin-bottom: 5px; 
        }
        
        .input-area { 
            padding: 20px; 
            border-top: 1px solid #e0e0e0; 
            background: #fafafa; 
        }
        .selection-info {
            padding: 10px 15px;
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #1976d2;
            display: none;
        }
        .selection-info.active {
            display: block;
        }
        .selection-info strong {
            display: inline;
            font-weight: 600;
        }
        .selection-info .clear-btn {
            float: right;
            cursor: pointer;
            color: #f44336;
            font-weight: bold;
        }
        .input-group { 
            display: flex; 
            gap: 10px; 
        }
        .voice-toggle { 
            padding: 12px 20px; 
            background: #f44336; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            min-width: 120px; 
            transition: all 0.3s; 
        }
        .voice-toggle.active { 
            background: #4caf50; 
        }
        input { 
            flex: 1; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px; 
        }
        input:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        button.send { 
            padding: 12px 24px; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: background 0.2s; 
        }
        button.send:hover { 
            background: #5568d3; 
        }
        
        .status { 
            padding: 10px 15px; 
            text-align: center; 
            font-size: 12px; 
            color: #666; 
            border-bottom: 1px solid #e0e0e0; 
        }
        .status.connected { 
            background: #e8f5e9; 
            color: #2e7d32; 
        }
        
        .tts-toggle { 
            padding: 8px 15px; 
            background: #9c27b0; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 11px; 
        }
        .tts-toggle.enabled { 
            background: #4caf50; 
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .modal-content p {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.6;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .modal-actions button.cancel {
            background: #ddd;
            color: #333;
        }
        .modal-actions button.confirm {
            background: #667eea;
            color: white;
        }
        
        #hp-preview {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
    <script src="/static/modification.js?v=428941c"></script>
</head>
<body>
    <div class="container">
        <div class="preview-pane">
            <div class="preview-header">
                <h3>??? HPプレビュー</h3>
                <div class="preview-actions">
                    <button onclick="refreshPreview()">?? 更新</button>
                    <button onclick="openInNewTab()">?? 新規タブで開く</button>
                </div>
            </div>
            <!-- ★★★ 修正: iframe srcを同一オリジンに変更 ★★★ -->
            <iframe id="hp-preview" src="/preview/"></iframe>
        </div>
        
        <div class="sidebar">
            <div class="header">
                <h2>AI HP作成アシスタント</h2>
                <p>Google Cloud TTS対応版</p>
            </div>
            
            <div class="status" id="status">接続確認中...</div>
            <div class="voice-status stopped" id="voice-status">音声認識: 停止中</div>
            
            <div class="actions">
                <button class="primary" onclick="generateRevisionSpecs()">?? 修正指示書生成</button>
                <button onclick="downloadSpecs()">?? 指示書DL</button>
                <button class="success" onclick="triggerBuild()">?? ビルド開始</button>
                <button class="tts-toggle" id="tts-toggle" onclick="toggleTTS()">?? 音声OFF</button>
            </div>
            
            <div class="chat-area" id="chat-area"></div>
            
            <div class="input-area">
                <div class="selection-info" id="selection-info">
                    <span class="clear-btn" onclick="clearSelection()">?</span>
                    <strong>選択中:</strong> <span id="selection-text"></span>
                </div>
                <div class="input-group">
                    <button class="voice-toggle" id="voice-btn" onclick="toggleContinuousVoice()">?? 音声開始</button>
                    <input type="text" id="message-input" placeholder="修正内容を入力..." onkeydown="if(event.key==='Enter') sendMessage()">
                    <button class="send" onclick="sendMessage()">送信</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="build-modal" class="modal">
        <div class="modal-content">
            <h3>?? ビルド進行中...</h3>
            <p id="build-status">元サイトを取得してAstroプロジェクトに変換中...</p>
            <div style="text-align: center; margin: 20px 0;">
                <div class="loading"></div>
            </div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeBuildModal()">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        let chatArea = document.getElementById('chat-area');
        let messageInput = document.getElementById('message-input');
        let statusEl = document.getElementById('status');
        let voiceBtn = document.getElementById('voice-btn');
        let voiceStatusEl = document.getElementById('voice-status');
        let ttsToggle = document.getElementById('tts-toggle');
        let recognition = null;
        let isListening = false;
        let isTTSEnabled = true;
        let interimMessageEl = null;
        let currentSessionId = null;
        let currentJobId = null;
        let selectedText = null;
        let selectedElement = null;
        let currentAudio = null;
        let audioQueue = [];
        let isPlaying = false;

        // Google Cloud TTS を使用した音声合成
        async function speakTextGCP(text) {
            if (!isTTSEnabled) {
                console.log('[TTS] Disabled, skipping');
                return;
            }

            console.log('[TTS] Queuing text:', text.substring(0, 50) + '...');
            audioQueue.push(text);
            
            if (!isPlaying) {
                playNextInQueue();
            }
        }

        async function playNextInQueue() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                voiceStatusEl.textContent = '音声認識: 停止中';
                voiceStatusEl.className = 'voice-status stopped';
                return;
            }

            isPlaying = true;
            const text = audioQueue.shift();
            
            try {
                voiceStatusEl.textContent = '?? 音声再生中...';
                voiceStatusEl.className = 'voice-status speaking';
                
                console.log('[TTS] Synthesizing:', text.length, 'chars');
                
                const response = await fetch('/api/tts/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        language_code: 'ja-JP',
                        voice_name: 'ja-JP-Neural2-B',
                        speaking_rate: 1.0,
                        pitch: 0.0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'TTS failed');
                }

                console.log('[TTS] Received audio data:', data.text_length, 'chars');

                // Base64デコードしてAudioオブジェクトを作成
                const audioBlob = base64ToBlob(data.audio, 'audio/mpeg');
                const audioUrl = URL.createObjectURL(audioBlob);
                
                currentAudio = new Audio(audioUrl);
                
                currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    console.log('[TTS] Playback finished');
                    playNextInQueue();
                };
                
                currentAudio.onerror = (e) => {
                    console.error('[TTS] Playback error:', e);
                    URL.revokeObjectURL(audioUrl);
                    playNextInQueue();
                };
                
                await currentAudio.play();
                console.log('[TTS] Playing audio');
                
            } catch (error) {
                console.error('[TTS] Synthesis error:', error);
                addMessage('system', `音声合成エラー: ${error.message}`);
                playNextInQueue();
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        function stopCurrentAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            audioQueue = [];
            isPlaying = false;
            voiceStatusEl.textContent = '音声認識: 停止中';
            voiceStatusEl.className = 'voice-status stopped';
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (interimTranscript) {
                    if (!interimMessageEl) {
                        interimMessageEl = document.createElement('div');
                        interimMessageEl.className = 'message interim';
                        interimMessageEl.innerHTML = '<strong>認識中...</strong>' + interimTranscript;
                        chatArea.appendChild(interimMessageEl);
                    } else {
                        interimMessageEl.innerHTML = '<strong>認識中...</strong>' + interimTranscript;
                    }
                    chatArea.scrollTop = chatArea.scrollHeight;
                }

                if (finalTranscript) {
                    if (interimMessageEl) {
                        interimMessageEl.remove();
                        interimMessageEl = null;
                    }
                    
                    const cleanText = finalTranscript.trim();
                    if (cleanText) {
                        messageInput.value = cleanText;
                        sendMessage();
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error('音声認識エラー:', event.error);
                if (event.error !== 'no-speech') {
                    addMessage('system', `音声認識エラー: ${event.error}`);
                    stopContinuousVoice();
                }
            };

            recognition.onend = () => {
                if (isListening) {
                    try {
                        recognition.start();
                    } catch (e) {
                        setTimeout(() => {
                            if (isListening) recognition.start();
                        }, 1000);
                    }
                }
            };
        }

        function toggleContinuousVoice() {
            if (!recognition) {
                alert('このブラウザは音声認識に対応していません');
                return;
            }
            isListening ? stopContinuousVoice() : startContinuousVoice();
        }

        function startContinuousVoice() {
            isListening = true;
            voiceBtn.classList.add('active');
            voiceBtn.textContent = '?? 音声停止';
            voiceStatusEl.textContent = '音声認識: 実行中';
            voiceStatusEl.className = 'voice-status listening';
            
            try {
                recognition.start();
                addMessage('system', '連続音声認識を開始しました');
            } catch (e) {
                console.error('音声認識開始エラー:', e);
                stopContinuousVoice();
            }
        }

        function stopContinuousVoice() {
            isListening = false;
            voiceBtn.classList.remove('active');
            voiceBtn.textContent = '?? 音声開始';
            voiceStatusEl.textContent = '音声認識: 停止中';
            voiceStatusEl.className = 'voice-status stopped';
            
            if (recognition) recognition.stop();
            if (interimMessageEl) {
                interimMessageEl.remove();
                interimMessageEl = null;
            }
            
            addMessage('system', '音声認識を停止しました');
        }

        function toggleTTS() {
            isTTSEnabled = !isTTSEnabled;
            ttsToggle.textContent = isTTSEnabled ? '?? 音声ON' : '?? 音声OFF';
            ttsToggle.className = isTTSEnabled ? 'tts-toggle enabled' : 'tts-toggle';
            
            if (!isTTSEnabled) {
                stopCurrentAudio();
            }
        }

        // ★★★ 修正: 起動時の初期化ログを追加 ★★★
        window.addEventListener('load', () => {
            console.log('[INIT] System starting...');
            console.log('[INIT] Preview URL: /preview/ (Same-Origin)');
            chatArea.innerHTML = '';
            addMessage('system', 'システムが起動しました (Google Cloud TTS)');
            addMessage('system', 'プレビューは同一オリジンで動作します');
            checkConnection();
            createSession();
            
            setupPostMessageListener();
        });
        
        // ★★★ 追加: postMessageで選択情報を受信 ★★★
        function setupPostMessageListener() {
            window.addEventListener('message', (event) => {
                if (event.data.type === 'text-selected') {
                    console.log('[postMessage] Received selection:', event.data);
                    
                    selectedText = event.data.text;
                    selectedElement = {
                        tagName: event.data.tagName,
                        className: event.data.className,
                        id: event.data.id,
                        selector: event.data.selector,
                        textContent: event.data.text,
                        selectedText: event.data.text,  // Gemini用に明示的に追加
                        markId: event.data.markId  // パターンB用にmarkIdを保存
                    };
                    
                    const selectionTextEl = document.getElementById('selection-text');
                    const selectionInfoEl = document.getElementById('selection-info');
                    
                    if (selectionTextEl && selectionInfoEl) {
                        selectionTextEl.textContent = event.data.text.length > 50 
                            ? event.data.text.substring(0, 50) + '...' 
                            : event.data.text;
                        selectionInfoEl.classList.add('active');
                    }
                    
                    console.log('[postMessage] Selection saved:', selectedText);
                }
            });
            console.log('[postMessage] Listener setup complete');
        }

        function clearSelection() {
            console.log('[clearSelection] Clearing selection...');
            
            selectedText = null;
            selectedElement = null;
            
            const selectionInfoEl = document.getElementById('selection-info');
            const selectionTextEl = document.getElementById('selection-text');
            
            if (selectionInfoEl) selectionInfoEl.classList.remove('active');
            if (selectionTextEl) selectionTextEl.textContent = '';
            
            if (window.modificationManager) {
                window.modificationManager.clearSelection();
            }
            
            console.log('[clearSelection] Selection cleared');
        }

        async function checkConnection() {
            try {
                const res = await fetch('/health');
                if (res.ok) {
                    const data = await res.json();
                    statusEl.textContent = `接続中 (TTS: ${data.tts_configured ? 'OK' : 'NG'})`;
                    statusEl.classList.add('connected');
                }
            } catch (error) {
                statusEl.textContent = '未接続';
            }
        }

        async function createSession() {
            try {
                const res = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caseType: 'renewal',
                        clientInfo: {
                            name: 'サンプルクライアント',
                            project: 'HPリニューアル'
                        },
                        content: {
                            type: 'url',
                            value: '/preview'
                        }
                    })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    currentSessionId = data.sessionId;
                    addMessage('system', `セッション開始: ${currentSessionId.substring(0, 8)}`);
                    
                    if (window.modificationManager) {
                        window.modificationManager.setSessionId(currentSessionId);
                        console.log('[createSession] SessionID set to modificationManager');
                    }
                }
            } catch (error) {
                console.error('セッション作成エラー:', error);
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            
            console.log('[sendMessage] Called with message:', message);
            console.log('[sendMessage] selectedText:', selectedText);
            console.log('[sendMessage] selectedElement:', selectedElement);
            
            if (!message) {
                console.log('[sendMessage] Empty message, returning');
                return;
            }

            let finalMessage = message;
            let displayMessage = message;
            
            if (selectedText) {
                const selectionInfo = `【選択箇所】\nテキスト: "${selectedText}"\n要素: ${selectedElement?.tagName || '不明'}\n\n【修正依頼】\n`;
                finalMessage = selectionInfo + message;
                displayMessage = `?? ${selectedText.substring(0, 30)}${selectedText.length > 30 ? '...' : ''}\n\n${message}`;
                console.log('[sendMessage] Added selection info');
            }

            addMessage('user', displayMessage);
            messageInput.value = '';

            console.log('[sendMessage] Sending to server...');

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: currentSessionId,
                        selection: selectedElement
                    })
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                console.log('[sendMessage] Response from /api/chat:', data);
                console.log('[sendMessage] data.action:', data.action);
                console.log('[sendMessage] data.modification:', data.modification);
                console.log('[sendMessage] data.response:', data.response);

                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                // immediate修正の場合、即座に適用
                if (data.action === 'immediate' && data.modification) {
                    console.log('[sendMessage] ✅ Action is immediate, applying modification...');
                    console.log('[sendMessage] Applying immediate modification:', data.modification);

                    if (window.modificationManager) {
                        const result = window.modificationManager.applyModificationFromJSON(data.modification);
                        console.log('[sendMessage] Modification result:', result);
                    } else {
                        console.error('[sendMessage] modificationManager not found!');
                    }

                    // responseメッセージを表示
                    addMessage('ai', data.response);
                    speakTextGCP(data.response);
                } else {
                    // question や batch の場合は通常表示
                    console.log('[sendMessage] ⚠️ Action is NOT immediate:', data.action);
                    console.log('[sendMessage] Modification will not be applied');
                    addMessage('ai', data.response);
                    speakTextGCP(data.response);
                }

                clearSelection();

            } catch (error) {
                console.error('[sendMessage] Server error:', error);
                addMessage('system', `エラー: ${error.message}`);
            }
        }

        function addMessage(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            const label = type === 'user' ? '?? あなた' : type === 'ai' ? '?? AI' : '?? システム';
            div.innerHTML = `<strong>${label}</strong>${text}`;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function generateRevisionSpecs() {
            if (!window.modificationManager) {
                addMessage('system', 'ModificationManagerが初期化されていません');
                return;
            }

            const modifications = window.modificationManager.getModifications();
            console.log('[generateRevisionSpecs] 修正件数:', modifications.length);

            if (modifications.length === 0) {
                addMessage('system', '修正履歴がありません');
                return;
            }

            try {
                addMessage('system', '修正指示書を生成中...');
                
                const instructionDoc = window.modificationManager.generateInstructionDocument();
                
                addMessage('system', '修正指示書が生成されました');
                addMessage('ai', instructionDoc);
                speakTextGCP('修正指示書の生成が完了しました');
                
            } catch (error) {
                console.error('修正指示書生成エラー:', error);
                addMessage('system', `エラー: ${error.message}`);
            }
        }

        async function downloadSpecs() {
            if (!window.modificationManager) {
                addMessage('system', 'ModificationManagerが初期化されていません');
                return;
            }

            const modifications = window.modificationManager.getModifications();
            
            if (modifications.length === 0) {
                addMessage('system', '修正履歴がありません');
                return;
            }

            try {
                addMessage('system', '修正指示書をダウンロード中...');
                
                const instructionDoc = window.modificationManager.generateInstructionDocument();
                
                const blob = new Blob([instructionDoc], { type: 'text/markdown;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `修正指示書_${new Date().toISOString().slice(0,10)}.md`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                addMessage('system', '修正指示書をダウンロードしました');
                speakTextGCP('ダウンロードが完了しました');
                
            } catch (error) {
                console.error('ダウンロードエラー:', error);
                addMessage('system', `エラー: ${error.message}`);
            }
        }

        async function triggerBuild() {
            if (!currentSessionId) {
                addMessage('system', 'セッションが開始されていません');
                return;
            }
            
            document.getElementById('build-modal').style.display = 'block';
            document.getElementById('build-status').textContent = '元サイトを取得してAstroプロジェクトに変換中...';
            
            try {
                addMessage('system', 'ビルドサービスに接続中...');
                
                const buildRes = await fetch('/api/trigger-build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        diffData: {
                            originalUrl: '/preview',
                            changes: []
                        }
                    })
                });
                
                if (!buildRes.ok) {
                    const errorData = await buildRes.json();
                    throw new Error(errorData.error || 'ビルド失敗');
                }
                
                const buildData = await buildRes.json();
                
                if (!buildData.success) {
                    throw new Error(buildData.error || 'ビルド失敗');
                }
                
                currentJobId = buildData.jobId;
                
                document.getElementById('build-status').textContent = 'ビルド中...';
                addMessage('system', `ビルド開始: Job ID ${currentJobId.substring(0, 8)}`);
                speakTextGCP('ビルドを開始しました');
                
                if (buildData.logUrl) {
                    addMessage('system', `ログURL: ${buildData.logUrl}`);
                }
                
                checkBuildStatus(currentJobId);
                
            } catch (error) {
                console.error('ビルドエラー:', error);
                document.getElementById('build-status').textContent = `? エラー: ${error.message}`;
                addMessage('system', `ビルドエラー: ${error.message}`);
                speakTextGCP('ビルドに失敗しました');
            }
        }

        async function checkBuildStatus(jobId) {
            try {
                const res = await fetch(`/api/build-status/${jobId}`);
                
                if (!res.ok) {
                    throw new Error('ステータス取得失敗');
                }
                
                const data = await res.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'ステータス取得失敗');
                }
                
                if (data.status === 'completed') {
                    document.getElementById('build-status').textContent = '? デプロイ完了!';
                    addMessage('system', `?? デプロイ完了: ${data.deployUrl || 'URL不明'}`);
                    speakTextGCP('デプロイが完了しました');
                    
                    if (data.deployUrl) {
                        const iframe = document.getElementById('hp-preview');
                        iframe.src = 'about:blank';
                        setTimeout(() => {
                            iframe.src = data.deployUrl + '?t=' + new Date().getTime();
                        }, 100);
                    }
                    
                    setTimeout(() => {
                        closeBuildModal();
                    }, 2000);
                    
                } else if (data.status === 'failed') {
                    document.getElementById('build-status').textContent = `? 失敗: ${data.error}`;
                    addMessage('system', `ビルド失敗: ${data.error}`);
                    speakTextGCP('ビルドに失敗しました');
                    
                } else {
                    const statusText = data.status === 'building' ? 'ビルド中...' : 
                                      data.status === 'queued' ? 'キュー待機中...' :
                                      data.status === 'deploying' ? 'デプロイ中...' : '処理中...';
                    document.getElementById('build-status').textContent = statusText;
                    setTimeout(() => checkBuildStatus(jobId), 3000);
                }
            } catch (error) {
                console.error('ステータス確認エラー:', error);
                document.getElementById('build-status').textContent = `? エラー: ${error.message}`;
            }
        }

        function closeBuildModal() {
            document.getElementById('build-modal').style.display = 'none';
        }

        function refreshPreview() {
            const iframe = document.getElementById('hp-preview');
            const baseUrl = iframe.src.split('?')[0];
            iframe.src = 'about:blank';
            setTimeout(() => {
                iframe.src = baseUrl + '?t=' + new Date().getTime();
                addMessage('system', 'プレビューを更新しました');
            }, 100);
        }

        function openInNewTab() {
            const iframe = document.getElementById('hp-preview');
            window.open(iframe.src, '_blank');
        }
    </script>
</body>
</html>
